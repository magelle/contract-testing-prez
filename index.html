<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>N’ayez plus peur de refactorer vos API WEB</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css ">
		<link rel="stylesheet" href="css/custom.css">


		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h4>N’ayez plus peur</h4>
					<img src="images/refactor-meme.jpg"
						 alt="Refactor or don't that is the question" />
					<h4>de refactorer vos API WEB</h4>
				</section>
				<section>
					<table>
						<tr>
							<td style="text-align: center;"><h3>Jessica</h3></td>
							<td style="text-align: center;"><h2>&</h2></td>
							<td style="text-align: center;"><h3>Maxime</h3></td>
						</tr>
						<tr>
							<td><img src="images/carbon-it.png" height="60px"/></td>
							<td></td>
							<td><img src="images/novencia.jpg" height="60px"/></td>
						</tr>
						<tr>
							<td></td>
							<td></td>
							<td><a href="https://twitter.com/Maxime_gelle">@Maxime_gelle</a></td>
						</tr>
					</table>
				</section>

				<section>
					<section>
						<h2>#micro-services !!!</h2>
						<img src="images/thumb-up.gif" alt="Thumb up" />
					</section>
					<section>
						<h3>Notre architecture</h3>
						<img src="images/microservices-architecture.png"
							 alt="Notre super architcture, bon c'est un peu compliqué"
							 height="500px"/>
					</section>
				</section>

				<section>
					<section>
						<h3>New feature</h3>
						<img src="images/new.gif" alt="Add it without breaking everything" />
					</section>
					<section>
						<h3>Modifier une API</h3>
						<ul>
							<li>Combien ça va coûter ?</li>
							<li>Comment pas tout casser ?</li>
						</ul>
						<img src="images/peur.gif" alt="On a peur" />
					</section>
					<section>
						<h2>Ce qui serait génial</h2>
						<aside class="notes">
							C'est trop long ces points
						</aside>
					</section>
					<section>
						<h3>Une carte</h3>
						<img src="images/map-interaction.jpg" alt="interaction map" />
					</section>
					<section>
						<h3>Les formats</h3>
						<img src="images/form-to-fill.jpg" alt="interaction format"/>
						<aside class="notes">Les formats d'échanges, les vérifier</aside>
					</section>
					<section>
						<h3>Voir le futur</h3>
						<img src="images/crystal-ball.jpg" alt="Crystal ball" />
						<aside class="notes">
							<ul>
								<li>ça va fonctionner ?</li>
								<li>Qui va cassé ?</li>
								<li>Qui est impacté</li>
								<li>...</li>
							</ul>
						</aside>
					</section>
					<section>
						<h3>En gros</h3>
						<img src="images/layer-architecture.png" alt="Un service"
						     height="550px"/>
					</section>
					<section>
						<h3>D'habitude on teste ça</h3>
						<img src="images/tested-layer-architecture.png" alt="Un service"
						     height="550px"/>
					</section>
					<section>
						<h3>Mais ...</h3>
						<img src="images/not-tested-layer-architecture.png" alt="Interaction entre deux services"
							 height="550px"/>
						<aside class="notes">
							Mais les interactions sont mocké
						</aside>
					</section>
					<section>
						<h3>Autrement dit</h3>
						<img src="images/interactions-to-test.png"
						     alt="Interaction entre les services"
							 height="550px"/>
					</section>
				</section>

				<section>
					<section>
						<h2>Contract Testing !</h2>
					</section>
					<section>
						<h3>Tester les interactions</h3>
						<img src="images/contract-testing-principle.png" height="400px"
								alt="both consumer and provider should verify the contract" />
						<aside class="notes">
							Tester les interactions entre consumer et provider
						</aside>
					</section>
					<section>
						<h3>Provider</h3>
						<blockquote>Celui qui propose l'API</blockquote>
						<p>Exemple: Mon service REST</p>

						<aside class="notes">
							An application (often called a service) that provides functionality or data for other applications to use, often via an API.

							For applications that use HTTP, the provider is the application that returns the response.
							For applications that use queues, the provider (also called producer) is the application that writes the messages to the queue.
						</aside>
					</section>
					<section>
						<h3>Consumer</h3>
						<blockquote>Celui qui appelle l'API</blockquote>
						<p>Exemple: Mes clients Angular</p>

						<aside class="notes">
							An application that makes use of the functionality or data from another application to do its job.

							For applications that use HTTP, the consumer is always the application that initiates the HTTP request (eg. the web front end), regardless of the direction of data flow.
							For applications that use queues, the consumer is the application that reads the message from the queue.
						</aside>
					</section>
					<section>
						<h3>Comment ?</h3>
						<img src="images/contract-testing-mocks.png"
								alt="Un contract, tester avec des mocks"
								height="500px"/>
					</section>
					<section>
						<h2>On définit un contrat</h2>
						<img src="images/a-contract-and-interactions.png" alt="Un contract"
							 height="400px"/>
					</section>
					<section>
						<h2>Et des interactions</h2>
						<img src="images/interaction.png" alt="Une interaction"
							 height="400px"/>
					</section>

					<section>
						<h2>Tests</h2>
						<img src="images/full-test-1.png" alt="Une interaction"
							 height="300px"/>
					</section>

					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-2.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>
					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-3.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>
					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-4.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>
					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-5.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>
					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-6.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>
					<section data-transition="none" data-background="#cef28f">
						<h4>Test d'un consumer</h4>
						<img src="images/full-test-7.png" height="300px"/>
						<aside class="notes">Maxime</aside>
					</section>


					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-8.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>
					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-9.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>
					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-10.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>
					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-11.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>
					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-12.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>
					<section data-transition="none" data-background="#b5d0ff">
						<h4>Test d'un provider</h4>
						<img src="images/full-test-13.png" height="300px"/>
						<aside class="notes">Jessica</aside>
					</section>

					<section data-transition="slide" >
						<h2>Au global</h2>
						<img src="images/both-tests.png" alt="Global view" height="250px">
						<aside class="notes">Maxime</aside>
					</section>
				</section>

				<section>
					<section>
						<h3>Qui définit le contrat ?</h3>
						<h4>Consumer driven VS Provider driven</h4>
						<aside class="notes">Maxime</aside>
					</section>

					<section>
						<h3>Provider Driven</h3>
						<blockquote>Je fonctionne de cette manière</blockquote>
						<img src="images/provider-driven-contract.png"
						     alt="Un contrat pour tous les consumers" />
						<aside class="notes">Jessica</aside>
 					</section>

					<section>
						<h3>Consumer Driven</h3>
						<blockquote>J'ai besoin de ça</blockquote>
						<img src="images/consumer-driven-contract.png"
						     alt="Plusieurs contract pour un provider" />
						<aside class="notes">Jessica</aside>
					</section>

					<section>
						<h2>C'est qui le plus fort ?</h2>
						<aside class="notes">MAxime</aside>
					</section>

					<section>
						<h3>Quand faire du provider driven ?</h3>
                        <ul>
							<li>Consumers inconnus</li>
							<li>Beaucoup de consumers</li>
							<li>Communication difficile</li>
						</ul>
						<blockquote>ex: Api publique de Twitter</blockquote>
						<aside class="notes">Jessica</aside>
					</section>
					<section>
						<h3>Quand faire du consumer driven ?</h3>
                        <ul>
							<li>Peu de consumers</li>
							<li>Communication aisée</li>
						</ul>
						<blockquote>ex: Backend for Frontend</blockquote>
						<aside class="notes">Jessica</aside>
					</section>
				</section>

				<section>
					<h3>Des outils</h3>
					<table>
						<tr>
							<td style="text-align: center;">Spring cloud contract</td>
							<td style="text-align: center;">Pact</td></tr>
						<tr>
							<td><img src="images/spring-cloud.jpg" alt="Spring cloud logo"/></td>
							<td><img src="images/pact-logo.png" alt="Pact logo" ></td>
						</tr>		
					</table>
				</section>

				<section>
					<section>
						<img src="images/pact-logo.png" alt="Pact logo" >
						<aside class="notes">Jessica</aside>
					</section>
					<section>
						<h3>Pourquoi ?</h3>
						<ul>
							<li>Consumer driven Contract Testing </li>
							<li>Open source</li>
							<li>Communauté active</li>
							<li>Bien documenté</li>
						</ul>
					</section>
					<section>
						<h3>Polyglote</h3>
						<img src="images/logo-techno/ruby.png" height="100px">
						<img src="images/logo-techno/java.png" height="100px">
						<img src="images/logo-techno/dotnet.png" height="100px">
						<img src="images/logo-techno/go.png" height="100px">
						<img src="images/logo-techno/javascript.png" height="100px">
						<img src="images/logo-techno/swift.png" height="100px">
						<img src="images/logo-techno/php.png" height="100px">
					</section>
					<section>
						<h3>Echange des contrats</h3>
						<ul>
							<li>Commit dans le Provider</li>
							<li>Github, bitbucket, ...</li>
							<li>Amazon S3</li>
							<li>Nexus / Artifactory</li>
							<li><b>Pact Broker</b></li>
						</ul>
					</section>
					<section>
						<h3>Pact Broker</h3>
						<ul>
							<li>Regroupe les Pacts</li>
							<li>Documentation</li>
							<li>Carte des interactions</li>
						</ul>
						<aside class="notes">Maxime</aside>
					</section>
					<section>
						<h3>Pact Broker</h3>
						<img src="images/pact-broker-network-diagram.png" 
							 height="500px"
						     alt="interaction network"/>
					</section>
				</section>
				<section>

					<section>
						<h2>Démo</h2>
					</section>
					<section>
						<h2>Notre cas</h2>
						<img src="images/use-case.png" />
					</section>
<!--					<section>-->
<!--						<h3>Passer de</h3>-->
<!--						<pre><code class="hljs json">{-->
<!--	"id": 123,-->
<!--	"name": "mon produit",-->
<!--	"price": 499.99-->
<!--}</code></pre>-->
<!--						<h3 class="fragment fade-in">à</h3>-->
<!--						<pre class="fragment fade-in"><code class="hljs json">{-->
<!--	"id": 123,-->
<!--	"name": "mon produit",-->
<!--	"description": "Here is an amazing product !"-->
<!--}</code></pre>-->
<!--						<aside class="notes">-->
<!--							Scénario :-->
<!--							- On veut modifier l'amount en currency-->
<!--								=> fail d'un seul des deux contracts-->
<!--							- On veut ajouter le stock sur un des consumer-->
<!--						</aside>-->
<!--					</section>-->

					<section>
						<h3>Search Consumer : Définition du contrat</h3>
						<img src="images/full-test-1.png" alt="Une interaction"
							height="300px"/>
					</section>
                    <section data-background="#cef28f">
                        <h3>Search Consumer : Définition du contrat</h3>
                        <pre><code class="hljs java">@Pact(provider = "Catalog_Provider",consumer = "Search_Consumer")
fun getAnExistingProduct(builder: PactDslWithProvider):
                            RequestResponsePact {
    return builder
            .uponReceiving("Get a product")
            .method("GET")
            .path("/products/1")
            .willRespondWith()
            .status(HttpStatus.OK.value())
            .body(PactDslJsonBody()
                    .numberType("id", 1)
                    .stringType("name", "Shoes")
                    .asBody())
            .toPact()
}</code></pre></section>
					<section data-background="#cef28f">
						<h3>Contrat généré</h3>
						<pre><code class="hljs json">{
    "provider": {
        "name": "Catalog_Provider"
    },
    "consumer": {
        "name": "Search_Consumer"
    },
    "interactions": [
        {
            "description": "Get a product",
            "request": {
                "method": "GET",
                "path": "/products/1"
            },
            "response": {
                "status": 200,
                "headers": {
                    "Content-Type": "application/json"
                },
                "body": {
                    "id": 1,
                    "name": "Shoes"
                },
                "matchingRules": {
                    "body": {
                        "$.id": {
                            "matchers": [
                                {
                                    "match": "number"
                                }
                            ],
                            "combine": "AND"
                        },
                        "$.name": {
                            "matchers": [
                                {
                                    "match": "type"
                                }
                            ],
                            "combine": "AND"
                        }
                    }
                }
            }
        }
    ],
    "metadata": {
        "pactSpecification": {
            "version": "3.0.0"
        },
        "pact-jvm": {
            "version": "3.5.24"
        }
    }
}</code></pre>
					</section>
					<section data-background="#cef28f">
							<h2>Consumer Test</h2>
						<img src="images/full-test-7.png" height="300px"/>
					</section>
					<section data-background="#cef28f">
						<h2>Consumer Test</h2>
						<pre>
							<code class="hljs java">@Test
    fun shouldFindAProduct() {
        val products = client.getProduct(1)
        assertThat(products).isEqualTo(Product(1, "Shoes"))
    }</code>
						</pre>
					</section>

					<section data-background="#b5d0ff">
							<h2>Provider Test: Catalog</h2>
						<img src="images/full-test-13.png" height="300px"/>
					</section>
					<section data-background="#b5d0ff">
						<h2>Provider Test: Catalog</h2>
						<pre><code>@SpringBootTest(/*Standard Spring Conf*/)
@Provider("Catalog_Provider")
@PactBroker(scheme = "https", host = "magelle.pact.dius.com.au", port="443",
        authentication = PactBrokerAuth(scheme = "Bearer", username = "xxx"))
class CatalogContractTest {

    private val providerUrl = "http://localhost:8080"

    @TestTemplate
    @ExtendWith(PactVerificationInvocationContextProvider::class)
    fun pactVerificationTestTemplate(context: PactVerificationContext) {
        context.verifyInteraction()
    }

    @BeforeEach
    @Throws(Exception::class)
    fun before(context: PactVerificationContext) {
        context.target = HttpTestTarget.fromUrl(URL(providerUrl))
    }
}</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h3>Maintenant</h3>
						<img src="images/micro-services-architecture-tested.png" alt="tout est testé" 
						     height="500px"/>
					</section>
					<section>
						<h3>En plus</h3>
						<img src="images/Pyramide-test.png" alt="On descend d'un cran dans la pyramide des tests" />
						<aside class="notes">
							avant -> testé via e2e, test manuels, en prod<br/>
							maintenant -> test intégration<br/>
							+ rapide<br/>
							+ fiable<br/>
							- cher <br/>
						</aside>
					</section>
					<section>
						<h3>Attention</h3>
						<table>
							<thead>
							<tr>
								<td>Do</td>
								<td>Don't</td>
							</tr>
							</thead>
							<tbody>
							<tr>
								<td>
									<ul>
										<li>Tests d'interactions</li>
									</ul>
								</td>
								<td>
									<ul>
										<li>Tests fonctionnels</li>
										<li>Tests de charge</li>
									</ul>
								</td>
							</tr>
							</tbody>
						</table>
					</section>
				</section>

				<section>
					<section>
						<h2>Conclusion</h2>
						<ul>
							<li>Tester des interactions</li>
							<li>Partager les contrats</li>
							<li>Visualiser les échanges</li>
						</ul>
					</section>
					<aside class="notes">
						<ul>
							<li>Quel consumer va casser -> aucun</li>
							<li>Quel services sont impacté -> Pact broker network</li>
							<li>Qui consome quelle donnée -> Contract</li>
						</ul>
					</aside>

					<section>
						<h3>Les bémols</h3>
						<ul>
							<li>Charge en plus</li>
							<li>Consumer Driven -> plus de contrats</li>
							<li>Gestion des versions</li>
						</ul>
					</section>

					<section>
						<h3>de Provider driven</h3>
						<h3>à Consumer driven</h3>
						<ul>
							<li>Pact, polyglote</li>
							<li>Plus précis</li>
							<li>Plus lourd</li>
						</ul>
					</section>
				</section>
				
				<section>
					<h2>Questions ?</h2>
				</section>

			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
			});
		</script>
	</body>
</html>
